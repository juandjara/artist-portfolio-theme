---
import { getRelativeLocaleUrl } from "astro:i18n"
import { transformMediaInHTML } from "../lib/directus"

export type PostDetail = {
  id: string
  title: string
  content: string
  description: string
  date: string
  image: string
}

interface Props {
  post: PostDetail
}

const post = Astro.props.post
const lang = Astro.params.lang!

const content = transformMediaInHTML(post.content)
const description = transformMediaInHTML(post.description)
---

<div class="max-w-prose mx-auto mt-4">
  <a
    id="back-button"
    class="my-2 inline-block text-lg font-medium hover:bg-gray-500/10 px-2 py-1 rounded-md"
    href={getRelativeLocaleUrl(lang, "/archive", { normalizeLocale: false })}
    >&#8672; Back</a
  >
  <h2 class="text-link mb-8 text-3xl font-medium">{post.title}</h2>
  <div
    class="prose mt-2 mb-6 flex-grow dark:prose-invert prose-headings:underline prose-h1:text-xl prose-h1:font-bold prose-p:text-justify prose-a:text-blue-500 prose-img:rounded-lg prose-video:w-full prose-video:my-2"
  >
    <Fragment set:html={content} />
  </div>
  {
    post.description ? (
      <div class="prose mt-2 mb-6 dark:prose-invert prose-headings:underline prose-h1:text-xl prose-h1:font-bold prose-p:text-justify prose-a:text-blue-500 prose-img:rounded-xl">
        <Fragment set:html={description} />
      </div>
    ) : null
  }
</div>

<!-- Lightbox Modal -->
<div
  id="lightbox-modal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90"
>
  <!-- Close button -->
  <button
    id="lightbox-close"
    class="absolute right-4 top-4 z-50 text-4xl font-bold text-white hover:text-gray-300 focus:outline-none"
    aria-label="Close lightbox"
  >
    &times;
  </button>

  <!-- Previous button -->
  <button
    id="lightbox-prev"
    class="absolute left-4 top-1/2 z-50 -translate-y-1/2 text-5xl font-bold text-white hover:text-gray-300 focus:outline-none"
    aria-label="Previous image"
  >
    &#8249;
  </button>

  <!-- Image container -->
  <div class="flex h-full w-full items-center justify-center p-12">
    <img
      id="lightbox-image"
      class="max-h-full max-w-full object-contain"
      alt="Lightbox image"
    />
  </div>

  <!-- Next button -->
  <button
    id="lightbox-next"
    class="absolute right-4 top-1/2 z-50 -translate-y-1/2 text-5xl font-bold text-white hover:text-gray-300 focus:outline-none"
    aria-label="Next image"
  >
    &#8250;
  </button>

  <!-- Image counter -->
  <div
    id="lightbox-counter"
    class="absolute bottom-4 left-1/2 -translate-x-1/2 text-lg text-white"
  >
  </div>
</div>

<script>
  const backButton = document.getElementById("back-button")
  backButton?.addEventListener("click", (ev) => {
    const cameFromFeed = sessionStorage.getItem("artist_portfolio:from_feed")
    if (cameFromFeed === "true") {
      ev.preventDefault()
      history.back()
    }
  })

  // Lightbox functionality
  const modal = document.getElementById("lightbox-modal")
  const lightboxImage = document.getElementById("lightbox-image") as HTMLImageElement | null
  const closeButton = document.getElementById("lightbox-close")
  const prevButton = document.getElementById("lightbox-prev")
  const nextButton = document.getElementById("lightbox-next")
  const counter = document.getElementById("lightbox-counter")

  let images: HTMLImageElement[] = []
  let currentIndex = 0

  // Find all images in the content areas
  function initLightbox() {
    const contentDivs = document.querySelectorAll(".prose")
    contentDivs.forEach((div) => {
      const imgs = div.querySelectorAll("img")
      imgs.forEach((img) => {
        images.push(img as HTMLImageElement)
        img.style.cursor = "pointer"
        img.addEventListener("click", () => {
          currentIndex = images.indexOf(img as HTMLImageElement)
          openLightbox()
        })
      })
    })
  }

  function openLightbox() {
    if (!modal || !lightboxImage || images.length === 0) return

    modal.classList.remove("hidden")
    modal.classList.add("flex")
    updateImage()
    updateNavigation()

    // Prevent body scroll
    document.body.style.overflow = "hidden"
  }

  function closeLightbox() {
    if (!modal) return

    modal.classList.add("hidden")
    modal.classList.remove("flex")

    // Restore body scroll
    document.body.style.overflow = ""
  }

  function updateImage() {
    if (!lightboxImage || images.length === 0) return

    const currentImage = images[currentIndex]
    lightboxImage.src = currentImage.src
    lightboxImage.alt = currentImage.alt || "Image"

    // Update counter
    if (counter) {
      counter.textContent = `${currentIndex + 1} / ${images.length}`
    }
  }

  function updateNavigation() {
    if (!prevButton || !nextButton) return

    // Hide navigation buttons if only one image
    if (images.length <= 1) {
      prevButton.style.display = "none"
      nextButton.style.display = "none"
    } else {
      prevButton.style.display = "block"
      nextButton.style.display = "block"
    }
  }

  function showPrevImage() {
    currentIndex = (currentIndex - 1 + images.length) % images.length
    updateImage()
  }

  function showNextImage() {
    currentIndex = (currentIndex + 1) % images.length
    updateImage()
  }

  // Event listeners
  closeButton?.addEventListener("click", closeLightbox)

  // Close on overlay click (but not on image click)
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) {
      closeLightbox()
    }
  })

  prevButton?.addEventListener("click", (e) => {
    e.stopPropagation()
    showPrevImage()
  })

  nextButton?.addEventListener("click", (e) => {
    e.stopPropagation()
    showNextImage()
  })

  // Keyboard navigation
  document.addEventListener("keydown", (e) => {
    if (modal?.classList.contains("hidden")) return

    if (e.key === "Escape") {
      closeLightbox()
    } else if (e.key === "ArrowLeft") {
      showPrevImage()
    } else if (e.key === "ArrowRight") {
      showNextImage()
    }
  })

  // Initialize lightbox when DOM is ready
  initLightbox()
</script>
