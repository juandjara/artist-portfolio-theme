---
import type { GetStaticPathsResult } from "astro"
import BaseLayout from "../../../layouts/BaseLayout.astro"
import { formatImageURL } from "../../../lib/directus"
import { getTranslations } from "../../../lib/directus"
import { getAllPosts } from "../../../lib/directus"
import { i18nConfig } from "../../../lib/i18n"
import PostDetail from "../../../components/PostDetail.astro"

export async function getStaticPaths() {
  const posts = await getAllPosts()
  return i18nConfig.locales
    .map((lang) => {
      return posts.map((p) => {
        const translations = getTranslations(p.translations, lang)
        const title = translations?.title ?? ""
        const subtitle = translations?.subtitle ?? ''
        const content = translations?.content ?? ""
        const description = translations?.description ?? ""
        const imageFile =
          typeof p.image === "object" && p.image ? p.image : null

        const blocks = (p.blocks ?? []).filter(
          (b) => typeof b !== "string" && !!b,
        ) ?? []

        const postProp = {
          id: p.id,
          title,
          subtitle,
          content,
          description,
          blocks,
          date: new Date(p.published_at ?? "").toLocaleDateString(),
          image:
            formatImageURL(imageFile?.id, undefined, imageFile?.type) ?? "",
        }

        return {
          params: { lang, post: p.id },
          props: { post: postProp },
        }
      }) satisfies GetStaticPathsResult
    })
    .flat()
}

const post = Astro.props.post
---

<BaseLayout pageTitle={post.title}>
  <PostDetail post={post} />
</BaseLayout>
